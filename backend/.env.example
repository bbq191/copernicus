# LLM Configuration (Ollama native API)
LLM_BASE_URL=http://localhost:11434
LLM_MODEL_NAME=qwen3:latest
LLM_TEMPERATURE=0.1
LLM_TIMEOUT=120                                                         # 单次请求超时（秒），超时后使用原文 fallback
LLM_MAX_RETRIES=2                                                       # LLM 调用失败重试次数（指数退避）
LLM_RETRY_DELAY=2.0                                                     # 首次重试延迟（秒），后续 2x 递增
LLM_MAX_CONCURRENT=3                                                    # 全局 LLM 并发上限
OLLAMA_NUM_CTX=32768
OLLAMA_NUM_CTX_CORRECTION=16384

# ASR 模式: paraformer (说话人分离) | sensevoice (抗噪增强)
ASR_MODE=paraformer

# Paraformer 模型配置 (ASR_MODE=paraformer 时使用)
# 使用分离模型组合，VAD 可以控制切分参数防止 OOM
ASR_MODEL_DIR=iic/speech_seaco_paraformer_large_asr_nat-zh-cn-16k-common-vocab8404-pytorch
VAD_MODEL_DIR=iic/speech_fsmn_vad_zh-cn-16k-common-pytorch
PUNC_MODEL_DIR=iic/punc_ct-transformer_zh-cn-common-vocab272727-pytorch
SPK_MODEL_DIR=iic/speech_campplus_sv_zh-cn_16k-common

# SenseVoice 模型配置 (ASR_MODE=sensevoice 时使用)
# SenseVoice 需配合 VAD 使用，系统会自动将长音频切分为 15 秒片段
# 支持 Emoji 和特殊标记自动清洗
SENSEVOICE_MODEL_DIR=iic/SenseVoiceSmall
SENSEVOICE_LANGUAGE=zh                                                   # auto | zh | en | yue | ja | ko
SENSEVOICE_MAX_SEGMENT_MS=15000                                          # 单段最大时长，超过则后处理分割

# 说话人分离配置 (基于声纹相似度聚类)
# 使用滑动窗口提取多个声纹 embedding，然后基于余弦距离聚类
SPK_SLIDING_WINDOW_MS=1500                                               # 声纹提取窗口大小
SPK_SLIDING_STEP_MS=750                                                  # 窗口滑动步长（50% 重叠）
SPK_SLIDING_THRESHOLD_MS=3000                                            # 超过此时长启用滑动窗口
SPK_DISTANCE_THRESHOLD=0.5                                               # 余弦距离阈值（0-1，越小越严格）

# 噪声过滤
FILTER_NOISE_SEGMENTS=true                                               # 过滤仅含语气词的纯噪声段落

# ASR 通用配置
# 重要：确保安装了 CUDA 版 PyTorch，否则会回退到 CPU
# pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
ASR_DEVICE=auto                                                          # auto | cuda | cpu
ASR_BATCH_SIZE=60                                                        # 说话人分离时自动限制为 60 秒以避免 OOM
ASR_DTYPE=float16                                                        # float32 | float16 | bfloat16
ASR_DISABLE_PBAR=true                                                    # 关闭推理进度条

# 音频增强 (ffmpeg loudnorm + 降噪)
AUDIO_ENHANCE=true                                                       # 解决说话人远近不一、背景嘈杂问题

# Correction Settings
# 每批次字符数上限，减小可加速单批处理（推荐 150-300）
# 批次越小，thinking 推理时间越短，但批次数量越多
CORRECTION_CHUNK_SIZE=200
CORRECTION_OVERLAP=50
CORRECTION_MAX_CONCURRENCY=3                                             # LLM 并发数
HOTWORD_REPLACER_ENABLED=true                                            # 热词后处理替换（阶段 2）
PYCORRECTOR_ENABLED=true                                                 # pycorrector 轻量级纠错（阶段 3）
PYCORRECTOR_MODEL=macbert                                                # macbert | kenlm

# Segment Pre-merge
PRE_MERGE_GAP_MS=1000

# Confidence-based filtering (ASR 置信度)
CONFIDENCE_THRESHOLD=0.95
CONFIDENCE_RUN_MERGE_GAP=3

# Evaluation (Map-Reduce 分段摘要)
# 长文本自动切分为多段分别提取要点，再合并生成最终评估
EVALUATION_MAX_TEXT_CHARS=50000                                          # 总上限，超过则截断
EVALUATION_CHUNK_SIZE=6000                                               # Map 分段大小，短于此直接评估
EVALUATION_NUM_CTX=8192                                                  # 评估专用 num_ctx，控制显存

# Compliance Audit (Map-Reduce)
COMPLIANCE_MAX_TEXT_CHARS=50000                                          # 总上限，超过则截断
COMPLIANCE_CHUNK_SIZE=4000                                               # Map 分段大小（字符）
COMPLIANCE_NUM_CTX=8192                                                  # 审核专用 num_ctx

# Cognitive Audit (Phase 3 -- 降低误报率)
COMPLIANCE_CONFIDENCE_THRESHOLD=0.7                                      # 置信度阈值，低于此值的违规被丢弃
COMPLIANCE_DEDUP_WINDOW_MS=30000                                         # 去重时间窗口（毫秒），同规则在此范围内合并
COMPLIANCE_GROUP_BY_SOURCE=true                                          # 按证据来源分组审核（transcript/ocr/mixed）
COMPLIANCE_OCR_MARGIN_MS=5000                                            # OCR 时间对齐容差（毫秒）

# HuggingFace 离线模式（可选，避免每次启动联网检查）
# HF_HUB_OFFLINE=1                                                       # 启用后完全离线，需先下载模型

# Hotwords (optional, path to a text file with one hotword per line)
# HOTWORDS_FILE=./hotwords.txt

# Task Execution
TASK_TIMEOUT_SECONDS=3600                                                # 单任务超时（秒），防止 ASR/LLM 卡住
TASK_MAX_IN_MEMORY=500                                                   # 内存中最大任务数

# Upload Settings
UPLOAD_DIR=./uploads
MAX_UPLOAD_SIZE_MB=15000

# CORS
CORS_ORIGINS=["http://localhost:3000"]

# Video Processing
VIDEO_EXTENSIONS=.mp4,.avi,.mov,.mkv,.flv,.wmv

# Keyframe Extraction
KEYFRAME_STRATEGY=interval                                               # interval | scene
KEYFRAME_INTERVAL_S=2.0                                                  # interval 模式：每 N 秒提取一帧
KEYFRAME_SCENE_THRESHOLD=0.3                                             # scene 模式：场景变化检测阈值
KEYFRAME_MAX_COUNT=500                                                   # 最大关键帧数
KEYFRAME_FORMAT=jpg
KEYFRAME_QUALITY=85

# OCR (RapidOCR)
OCR_ENABLED=true
OCR_CONFIDENCE_THRESHOLD=0.6                                             # OCR 置信度阈值
OCR_MIN_TEXT_LENGTH=2                                                    # 最短文本长度

# Face Detection (YOLO)
FACE_DETECT_ENABLED=true
FACE_DETECT_MODEL=models/yolov8n-face.pt
FACE_DETECT_CONFIDENCE=0.5
FACE_MISSING_THRESHOLD_MS=10000                                          # 人脸缺失超过此时长报告事件
